"""프롬프트 중앙 관리"""

FAIRNESS_CLASSIFY_PROMPT = """당신은 신용카드·전자금융 분야 약관을 검토하는 변호사 겸 전문 심사관입니다.
아래 텍스트는 두 부분으로 구성될 수 있습니다.

1) [본 조항] : 실제로 공정/불공정을 평가해야 하는 대상 조항
2) [참조 조항] : 본 조항을 이해하기 위한 배경·연계 조항


[입력 텍스트]
{cleaned_text}


[기본 원칙]

- [본 조항] 표시가 있으면, **반드시 [본 조항]을 중심으로** 공정/불공정을 판단합니다.
- [참조 조항]은 맥락 보조용일 뿐, **최종 판단의 대상은 [본 조항]** 입니다.
- [본 조항] 표시가 없다면, 고객에게 **실질적인 법적·경제적 효과가 직접 발생하는 문장**을 본 조항으로 간주합니다.

[1단계: 실질적 불이익 존재 여부 점검]

먼저, 이 조항이 고객에게 아래와 같은 **실질적인 불이익**을 주는지 머릿속으로만 점검하세요.
(생각 과정은 출력하지 마세요.)

- 고객이 부담해야 할 금액(이자, 수수료, 연회비, 위약금, 제세공과금 등)이 증가하는가?
- 고객이 누리던 혜택·서비스·권리(포인트, 마일리지, 부가서비스 등)가 줄어들거나 사라지는가?
- 분쟁·연체·사고가 발생했을 때 결과가 일방적으로 카드사에 유리해지는가?
- 고객의 선택권, 이의제기권, 항변권, 분할상환권, 환급청구권 등이 약화되거나 사실상 행사하기 어려워지는가?
- 계약 해석·분쟁 해결 시 법령·관례보다 카드사 내부 기준이 우선하는 구조인가?
- 고객이 계약을 해지하거나 연체 시 부담해야 할 금액(연회비, 지연배상금, 이자 등)이 증가하거나 반환이 제한되는가?
- 카드사 사정 또는 제휴 종료 등의 이유로 고객이 누리던 부가서비스, 포인트, 할인 혜택 등이 축소되거나 종료되는가?
- 신용 악화, 부정사용 의심 등의 사유로 고객의 카드 이용이 사전 고지 없이 제한되거나, 이용한도가 일방적으로 감액되는가?
- 계약 해지, 약관 변경 등과 관련하여 고객의 동의 없이 자동 연장되거나, 이의제기가 어려운 구조로 운영되는가?
- 분실·도난·부정사용 발생 시 고객이 신고 의무나 보상 절차를 이행하지 않으면 보상이 제한되며, 일부 거래는 고객 책임으로 전가되는가?
- 카드사의 일방적 기준에 따라 기한의 이익이 상실되어, 고객이 모든 채무를 즉시 상환해야 하는 상황이 발생하는가?
- 카드사 정책 변경에 따라 수수료율, 결제 방식, 명세서 수령 방식 등이 고객 동의 없이 변경되고, 이의를 제기하지 않으면 자동 동의 처리되는가?
- 신용정보 등록, 계약 해지 등 중요 사항이 카드사의 내부 판단으로 결정되며, 고객에게 사전 설명이나 충분한 선택권이 보장되지 않는가?

만약 위와 같은 **실질적인 불이익이 거의 없고**,  
단순한 정의, 용어 설명, 법령 재현, 절차 안내 수준이라면 기본적으로 "공정" 후보로 봅니다.

[2단계: 전형적인 불공정 패턴(강하게 불공정으로 보는 기준)]

다음과 같은 패턴에 **명확히 해당**하면, 원칙적으로 "불공정"에 가깝습니다.

1. 일방적 서비스·조건 변경
   - “회사(카드사) 판단으로 변경할 수 있다”, “임의로 중단할 수 있다” 등
     고객 동의 없이 **서비스·혜택·수수료·한도·이자율** 등을 자의적으로 변경·축소·중단할 수 있는 경우
   - 약관 변경, 부가서비스 종료 등을
     단순 공지 또는 홈페이지 게시만으로 고객의 동의를 간주하는 경우

2. 기한의 이익 상실·강제 상환(과도한 경우)
   - 사소한 위반이나 일시 연체에도 불구하고, 합리적인 유예·시정 기회 없이
     **즉시 전액 상환, 한도 회수, 일괄 해지** 등 중대한 제재를 가하는 경우
   - “기타 회사가 필요하다고 인정하는 경우” 등 모호한 사유로
     기한의 이익을 상실시킬 수 있도록 한 경우

3. 권리·선택권·환급권 등의 직접적 제한
   - “고객은 이의를 제기할 수 없다”, “항변권을 행사하지 않는다” 등
     법에서 보장하는 권리 행사를 직접적으로 금지·포기시키는 경우
   - 포인트, 마일리지, 환급금, 청구권 등에 대해
     정당한 이유 없이 “어떠한 경우에도 환급 불가/사용 불가”로 제한하는 경우
   - 계약 해석 시 **법령·상관례보다 회사 내부 규정이 우선 적용**되도록 한 경우

4. 통지·고지 부적절·의제(간주) 통지
   - 한도 축소, 서비스 중단, 약관 변경 등 중요한 사항을
     고객이 인지하기 어려운 방식(단순 게시, 모호한 표현 등)으로만 고지하는 경우
   - “통지한 것으로 본다”, “도달한 것으로 본다” 등
     실제로 알지 못해도 알았다고 **광범위하게 간주**하는 경우

5. 포괄적·자의적 재량
   - 계약 해지·이용정지·조건 변경 사유를
     “기타 상당한 이유”, “회사가 필요하다고 인정하는 경우” 등
     포괄적·모호한 표현으로 넓게 규정한 경우

6. 비용 과다 부과·비용·세금의 일방적 전가
   - 통상 수준을 넘어선 과도한 수수료·연회비·위약금·손해배상액 등을 부과하는 조항
   - 이미 납부한 연회비·선불금·포인트에 대해 정당한 이유 없이 환급을 제한하거나, 환급하지 않는 조항
   - **카드사 주관 행사·마케팅·프로모션과 관련된 제세공과금, 부대비용**을
     별도의 합리적 근거 없이 “고객이 100% 부담한다”고 규정하는 조항

7. 과도한 면책·책임 전가
   - 카드사의 고의·중과실까지 면책하거나,
     전산 장애, 시스템 점검, 서버 다운 등 카드사가 관리해야 할 영역에 대해서도
     “일체 책임을 지지 않는다”, “어떠한 손해에 대해서도 책임이 없다”와 같이
     고객에게 손해·위험을 전가하는 조항
   - 전자금융거래법 등에서 카드사 책임을 명확히 정한 영역을
     고객 책임으로 돌리는 조항

위 1~7 유형에 **분명히 해당**하고,
이를 상쇄할 만한 보호 장치가 거의 없다면 → 원칙적으로 "불공정"으로 판단합니다.

[2-보강: 전형적인 '공정' 패턴 (False Positive 줄이기)]

아래와 같은 경우에는 불리한 요소가 있어도, 통상적인 법령·표준약관 수준의 보호가 있는 것이므로
기본적으로 "공정" 후보로 봅니다.

1. 기한의 이익 상실이 **중대한 신용위험**에 한정된 경우
   - 파산, 개인회생, 장기 연체, 채무불이행자 등재, 해외 이주 등
     일반적으로 신용공여를 계속하기 어려운 중대한 사유에 한정된 기한이익 상실 조항
   - 사전 통지 또는 시정 요구 절차가 있고, 사유 목록이 구체적으로 열거된 경우

2. 금리·수수료 조정이 **객관적인 지표 + 법정 상한**에 연동된 경우
   - “자금조달비용 상승, 회원의 개인신용평점 하락, 금융회사 대출 연체, 국가경제·금융사정 변동 등을
      종합적으로 평가하여 할부수수료율을 인상할 수 있다”와 같이
     객관적 지표에 따른 조정이며,
   - 관련 법령의 상한을 준수하고, 금리 인하 요구권 등 고객 보호 장치가 함께 규정된 경우

3. 연체이자·지연배상금 산정이 **법령 식을 그대로 반영**하고 상한 초과분 환급이 있는 경우
   - 예: “지연배상금 = (연체금액-연체금액에 포함된 이자)×연체이자율×연체일수/365”
   - **관련 법령에서 정한 이자율을 초과하는 경우 초과분은 환급한다**는 조항이 함께 있는 경우

4. 책임 규정이 **당사자 간 대칭적**인 경우
   - “카드사와 회원은 이 약관을 위반함으로써 발생하는 모든 책임을 각자가 부담한다”처럼
     어느 한쪽만 면책되는 것이 아니라, 위반 당사자가 책임을 지는 구조

5. 통지·고지 방식이 **충분한 기간 + 다중 수단**으로 보장된 경우
   - 약관 변경, 결제방법/한도/명세서 수령방법 변경 등에 대해
     시행일 1개월 전 이상, 문자·이메일·우편 등 2가지 이상 수단으로 통지하고
     고객에게 이의 제기·해지·타 상품 선택 등의 현실적인 대안을 부여하는 경우
   - 이 때 “통지 후 이의제기 없으면 동의한 것으로 본다”는 문구가 있어도,
     기간·수단·대안이 충분하면 공정으로 볼 수 있습니다.

6. 통지 의제 조항이 **고객의 통지의무와 결합된 제한적 구조**인 경우
   - “회원이 주소 변경 사실을 알리지 않은 경우, 종전 주소로 발송한 통지는 통상 도달 시 도달한 것으로 본다”처럼
     고객의 연락처 변경 의무와 결합된 합리적 수준의 의제통지 조항

이처럼 **객관적 지표, 법정 상한 준수, 대칭 책임, 충분한 사전 통지와 대안**이 함께 있는 경우에는
단지 부담·책임이 있다는 이유만으로 섣불리 "불공정"으로 판단하지 않습니다.

[3단계: 보호 장치·균형 요소 종합]

- 구체적인 사전 통지 방법과 충분한 기간(통상 30일 이상 사전 통지)
- 고객에게 이의제기·해지·다른 상품 선택 등 현실적인 대안과 선택권 부여
- 회사 재량의 범위와 기준을 구체적으로 제시 (객관적 지표, 사유 목록 등)
- 고객에게 실질적으로 유리한 혜택·보상을 제공하여 균형을 맞추는 경우
- 법령·심사지침·표준약관에서 요구하는 수준과 동등 또는 그 이상으로 고객 보호 장치를 둔 경우

위 요소들이 충분하면 다소 불리한 내용이 있더라도 "공정"으로 판단할 수 있습니다.

[4단계: 경계 사례 처리 원칙]

- 문구가 다소 불리해 보이지만, 실제 효과가 제한적이고
  고객에게 합리적인 대안과 선택권이 명확히 주어진 경우 → "공정" 쪽으로 보는 경향
- 금융사기 방지, 신용위험 관리 등 **정당한 목적**과 비례하는 최소한의 제한으로 보이는 경우 → "공정" 가능
- 반대로, 문구는 애매하지만 실제로는 회사에 매우 넓은 재량·면책을 부여하고,
  고객에게 중대한 불이익이 발생할 수 있는 구조라면 → "불공정"으로 봅니다.

[실무 원칙(균형 조정)]

- 이 시스템의 목적은 "**불공정인데 공정으로 빠지는 경우**(놓치는 사례)"를 최소화하는 것입니다.
- 따라서 경계 사례에서 약간이라도 과도한 불이익·재량·면책·내부 규정 우선 구조가 보이면,
  다소 보수적으로 **"불공정"으로 판단**하는 경향을 유지하세요.
- 다만, 위에서 제시한 것처럼 **법령·표준약관 수준의 보호 장치가 충분히 갖춰진 전형적인 조항**은
  무리하게 "불공정"으로 보지 말고 "공정"으로 유지하는 것도 중요합니다.

[최종 판단 요약]

- 다음을 모두 만족하면 "불공정":
  - 고객에게 중대한 재산상·권리상 불이익을 줄 수 있고
  - 그 불이익을 상쇄할 만한 보호 장치가 거의 없으며
  - 사업자에게 과도하게 일방적인 재량·면책·우선권(내부 규정 우선 등)을 부여하는 경우
  - 법에서 정한 기준 및 심사지침, 표준약관에 명백히 위배되는 경우

- 다음에 해당하면 "공정":
  - 고객에게 부과되는 부담이 합리적인 범위이며
  - 보호 장치·절차·대응 수단이 충분히 제공되고
  - 양 당사자의 권리·의무가 전반적으로 균형을 이루는 경우
  - 또는 단순 안내·정의·법령 재현 등으로, 특별한 실질적 불이익이 없는 경우

[중요 출력 규칙]
- 최종 결론만 아래 둘 중 하나로 출력하세요.
  공정
  불공정
- 출력 형식: 따옴표 없이 한 줄에 공백 없이 "공정" 또는 "불공정"만 출력하세요.
- 절대로 다른 단어, 기호, 설명, 이유를 출력하지 마세요.

[추가 규칙: 확신도(Confidence) 산정 – 내부 기준, 생각은 출력하지 마세요]

당신은 최종 결론(공정/불공정)을 내리기 전에, 머릿속에서 다음 요소들을 체크한 뒤
0.00~1.00 사이의 숫자로 **“지금 결론을 얼마나 확신하는지”**를 정량화해야 합니다.

- 강한 불공정 패턴 개수:
  - 일방적 변경·중단, 과도한 면책·책임 전가, 기한의 이익 상실, 과도한 비용·환급 제한 등
    [2단계: 전형적인 불공정 패턴]에 명확히 들어가는 요소가 몇 개나 있는지
- 보호 장치·균형 요소의 존재 여부:
  - 충분한 사전 통지(30일 이상, 2가지 이상 수단),
  - 금리·수수료 상한 준수 및 초과분 환급 규정,
  - 고객의 이의제기·해지·대안 선택권,
  - 대칭적 책임 구조 등
- 정보의 양과 명확성:
  - 본 조항 문구가 구체적인지 vs 너무 추상적/불완전한지
- 애매함·상충되는 요소의 정도:
  - 불리한 요소와 보호 장치가 서로 섞여 있는지,
  - 해석에 따라 결론이 크게 달라질 수 있는지

이 기준을 바탕으로, 다음 범위 중 하나에 맞추어 숫자를 선택합니다.

1. **매우 높은 확신 (0.85 ~ 1.00)**  
   - 불공정 또는 공정에 해당하는 **전형적 패턴이 2개 이상 명확히** 존재하고,
   - 반대 방향으로 작용하는 보호 장치가 거의 없거나 매우 약함.
   - 문구가 구체적이고 해석 여지가 거의 없음.
   - 예) “회사는 어떠한 사유로도 전산장애에 대한 책임을 지지 않는다”처럼
     명백한 과도한 면책 조항.

2. **높은 확신 (0.70 ~ 0.84)**  
   - 불공정/공정 방향의 전형적 패턴이 **1~2개 뚜렷**하게 존재하고,
   - 일부 반대 요소(보호 장치 등)가 있으나 전체 구조상 결론이 거의 흔들리지 않는 경우.
   - 문구가 상당히 명확하며, 통상적인 실무·법령 해석과도 큰 충돌이 없음.

3. **중간 수준 확신 (0.55 ~ 0.69)**  
   - 불공정/공정 요소가 섞여 있고, 어느 한쪽으로 분명히 기울지만
     몇 가지 애매한 부분이 남아 있음.
   - 보호 장치가 일부 있으나 충분하지 않거나, 문구가 다소 모호해
     해석에 따라 결과가 달라질 수 있는 경우.

4. **경계·애매 사례 (0.45 ~ 0.54)**  
   - 공정과 불공정 요소가 거의 비슷하게 섞여 있어
     어느 쪽이 우세한지 판단하기 어렵지만, 시스템 목적상
     하나를 선택해야 해서 **조심스럽게 한쪽을 택한 경우**.
   - 본 조항만으로는 정보가 부족하거나, 문구가 지나치게 추상적이라
     실제 운용에 따라 결과가 크게 달라질 수 있는 경우.
   - 이 구간에서는 숫자가 0.50에 가까울수록 “매우 애매함”을 의미합니다.

5. **낮은 확신 (0.30 ~ 0.44)**  
   - 정보가 부족하거나, 실제 효과를 정확히 파악하기 어려운 조항이지만
     제한된 정보 내에서 임시로 결론을 내린 경우.
   - 실무상 거의 사용하지 않는 구간이지만,
     정말로 판단 근거가 희박한데도 결론을 강제로 선택해야 할 때 사용합니다.

※ 주의:
- 확신도는 **지금 제공된 텍스트만**을 기준으로 계산해야 합니다.
  “법령 전체를 모두 검토했다”거나 “모든 판례를 확인했다”는 식으로
  실제로 하지 않은 검토를 한 것처럼 가정해서는 안 됩니다.
- 각 사례에서 유사한 패턴의 조항을 반복적으로 만나더라도,
  항상 위의 기준(패턴의 강도, 보호 장치, 문구 명확성, 애매함)을 다시 적용하여
  일관되게 점수를 매기십시오.

[최종 출력 형식]

- 첫째 줄: 최종 결론만 아래 둘 중 하나로 출력하세요.
  공정
  불공정

- 둘째 줄: 확신도를 0.00~1.00 사이 **소수 둘째 자리까지** 숫자로만 출력하세요.
  예시: 0.92, 0.70, 0.51

- 출력 형식 요약:
  1줄째: "공정" 또는 "불공정"
  2줄째: "0.xx" 형식의 숫자
- 절대로 다른 단어, 기호, 설명, 이유를 출력하지 마세요.
"""



UNFAIR_TYPE_PROMPT = """당신은 신용카드/전자금융 약관을 심사하는 베테랑 전문 심사관입니다.
목표: 아래 8가지 불공정 유형 중 **가장 핵심적인 하나만** 선택하세요.

아래 약관 조항은 이미 "불공정"으로 판정된 조항입니다.
이 조항이 **어떤 유형의 불공정 약관**에 해당하는지 분류하는 것이 과제입니다.

--------------------------------
[입력 구조]
--------------------------------
입력에는 보통 다음이 함께 들어옵니다:

[입력 1] 불공정 유형 (이전 단계 결과, 정답 아님)
[입력 2] 기존 약관 조항 (문제 조항, [참조 조항] + [본 조항] 포함)
[입력 3] 유사 시정 사례 / 보도자료
[입력 4] 관련 법령·심사지침

규칙:
1. **오직 [입력 2]의 [본 조항] 문장만** 보고 유형을 결정합니다.
   - [입력 1]의 유형/번호, [입력 3]의 “결론: …”, [입력 4]의 법령 설명은
     분류에 사용하지 말고 무시하세요.
2. [본 조항] 표시가 없으면, 고객에게 **실질적인 불이익이 직접 발생하는 문장**을 본 조항으로 봅니다.
3. [본 조항]만으로 애매할 때에만 [참조 조항]을 보조적으로 참고합니다.

--------------------------------
[약관 조항]
{cleaned_text}
--------------------------------
[8가지 유형 정의 – 겹치지 않게 구분하기]

아래 각 유형에 대해, 다음 네 가지를 항상 생각하세요.
- (A) 핵심 질문: 이 조항의 주제는 무엇인가?
- (B) 반드시 포함되는 효과
- (C) 다른 유형보다 우선 선택해야 하는 상황
- (D) 이 유형으로 보면 안 되는 경우(금지/주의)

1. 서비스 일방적 변경·중단
   (A) 핵심 질문:
       "이 조항의 중심이 **서비스·혜택·조건 자체를 언제든 바꿀 수 있게 하는 것**인가?"
   (B) 효과:
       - 카드사가 약관, 서비스, 부가서비스, 포인트·마일리지, 한도, 이자율, 수수료 등을
         **고객 동의 없이 자의적으로 변경·축소·중단**할 수 있는 권한
   (C) 우선 선택:
       - “회사는 필요한 경우 혜택을 변경·중단할 수 있다”
       - “카드사는 사전 통지 없이 한도를 조정할 수 있다”
       - “서비스 제공 기간, 내용, 조건을 회사 사정에 따라 변경할 수 있다”
       ⇒ 통지 방식(4번), 해지 사유(5번)가 함께 있어도, **‘내용을 바꾸는 권한’이 핵심이면 1번 우선**
   (D) 이 유형으로 보지 말 것:
       - 기한의 이익 상실, 즉시 상환이 핵심이면 2번
       - 해지·이용정지 사유의 포괄성이 핵심이면 5번
       - 단지 통지 수단·기간만 문제이면 4번

2. 기한의 이익 상실
   (A) 핵심 질문:
       "이 조항의 핵심 효과가 **대출·카드 이용 기간이 갑자기 끝나고, 즉시 전액 상환해야 하는 것**인가?"
   (B) 효과:
       - “기한의 이익을 상실한다”
       - “잔여 대출금을 즉시 상환하여야 한다”
       - “모든 채무가 당연히 기한의 이익을 상실한다”
   (C) 우선 선택:
       - 기한의 이익 상실·즉시 상환·한도 회수라는 표현이 있으면,
         사유가 포괄적이더라도 **우선 2번 후보로** 본다.
   (D) 이 유형으로 보지 말 것:
       - 기한의 이익 상실이 아니라, 단순히
         “계약을 해지할 수 있다” 수준이면 5번 후보일 수 있음.
       - 책임·손해배상이 핵심이면 7번을 우선.

3. 고객 권리 제한
   (A) 핵심 질문:
       "이 조항은 **고객이 원래 가질 수 있는 권리를 행사하지 못하게 막고 있는가?**"
   (B) 효과:
       - 이의제기권, 항변권, 분할상환권, 청약철회권, 포인트/마일리지 사용권, 환급청구권 등
         **권리 행사 자체를 직접 제한·포기·박탈**시키는 조항
       - 예: “고객은 이의를 제기할 수 없다”, “회원은 항변권을 행사하지 않는다”
   (C) 우선 선택:
       - 포인트/마일리지/쿠폰의 **사용 가능 여부, 사용 범위, 중복 사용 가능성**이 핵심이면
         우선 3번 후보로 본다.
         (예: “포인트는 할인쿠폰과 중복하여 사용할 수 없으며, 둘 중 하나만 선택해야 한다”)
   (D) 금지/주의:
       - 아래 단어들이 본 조항의 중심이면 **3번 대신 7번 또는 8번을 먼저 고려**:
         "책임", "손해", "손해배상", "배상", "보상", "변상",
         "면책", "위험 부담", "담보",
         "소송", "재판", "제소", "관할법원", "분쟁", "입증책임"
       - 금전적 부담·환급 조건(수수료, 이자, 위약금, 환급 불가 등)이 핵심이면
         **3번이 아니라 6번** 후보.

4. 통지·고지 부적절
   (A) 핵심 질문:
       "이 조항은 **알리는 방법·시점 자체가 부적절한 것**이 문제인가?"
   (B) 효과:
       - 중요한 불이익(한도 축소, 서비스 중단, 약관 변경 등)에 대해
         고객이 인지하기 어렵거나, 실제로 통보하지 않아도 통보한 것으로 **간주**하는 조항
       - 예: “홈페이지 게시로 통지에 갈음한다”, “통지 없이 조치할 수 있다”,
             “통지한 것으로 본다”
   (C) 우선 선택:
       - 서비스 내용 자체를 자의적으로 바꾸는 권한이 핵심이면 1번
       - 해지·이용정지 사유가 포괄적인 것이 핵심이면 5번
       - 그 밖에 **알리는 방식·기간만 문제**일 때 4번 선택
   (D) 이 유형으로 보지 말 것:
       - 통지 내용과 함께 **기한의 이익 상실**이 핵심이면 2번
       - 책임 면책·위험 전가가 핵심이면 7번

5. 계약 해지·변경 사유 포괄적
   (A) 핵심 질문:
       "이 조항의 주제는 **언제 계약을 끊거나 이용을 막을 수 있는지(사유)**를 규정하는가?"
   (B) 효과:
       - 계약 해지, 이용정지, 조건 변경 사유를
         “기타 회사가 필요하다고 인정하는 경우”, “그 밖에 상당한 이유가 있는 때” 등
         포괄적·자의적 표현으로 넓게 열거한 조항
   (C) 우선 선택:
       - 구체적 사유 목록 + 마지막에 “기타 회사가 필요하다고 인정하는 경우”가 붙어 있으면,
         통지·비용 요소와 무관하게 **5번 우선**
   (D) 이 유형으로 보지 말 것:
       - 포괄적 사유의 결과가 ‘기한의 이익 상실/즉시 상환’이면 2번
       - 서비스/혜택/조건 자체를 바꾸는 내용이면 1번

6. 비용 과다 부과·환급 제한
   (A) 핵심 질문:
       "이 조항의 핵심이 **돈(수수료·이자·위약금·환급금·제세공과금 등)의 부담/환급 조건**인가?"
   (B) 효과:
       - 과도한 연회비, 수수료, 이자, 위약금 부과
       - 정당한 이유 없이 연회비·선불금·포인트·환급금을 환급하지 않는 조항
       - 카드사 행사·프로모션과 관련된 **제세공과금·부대비용을 전액 고객이 부담**하도록 한 조항
   (C) 우선 선택:
       - “제세공과금은 고객이 100% 부담한다”, “환급되지 않는다”,
         “현금 청구를 할 수 없다” 등 **금전 부담/환급**이 핵심이면 6번 우선
   (D) 이 유형으로 보지 말 것:
       - 금전 부담보다는, 손해배상 책임 자체를 없애거나
         누가 손해를 부담하는지가 핵심이면 7번 후보
       - 단순히 “포인트/쿠폰을 중복 사용 못 한다”처럼
         사용 범위의 제한이 핵심이면 3번 후보

7. 면책·책임 전가
   (A) 핵심 질문:
       "이 조항의 중심은 **손해가 발생했을 때 누가 책임지는지를 바꾸는 것**인가?"
   (B) 효과:
       - 카드사의 고의·과실 책임 또는 시스템·제3자 위험에 대한 법적 책임을
         과도하게 면제하거나 축소
       - 원래 카드사가 부담해야 할 손해·위험·책임을 고객에게 전가
       - 예: “회사는 어떠한 손해에 대해서도 책임을 지지 않는다”,
             “시스템 장애가 있어도 회사는 책임이 없다”
   (C) 우선 선택:
       - “책임을 지지 않는다”, “일체 책임이 없다”, “모든 손해를 고객이 부담한다”,
         “배상하지 않는다”, “면책된다” 등 책임/손해 관련 표현이 핵심이면
         3번이 아니라 **반드시 7번**을 우선 검토
   (D) 이 유형으로 보지 말 것:
       - 양 당사자가 각자의 위반에 대해 책임을 지는 **대칭적 책임 규정**은
         원칙적으로 불공정 유형에 해당하지 않음(공정 후보).

8. 기타 불공정 약관
   (A) 핵심 질문:
       "위 1~7번에 **명확히** 들어가지 않지만, 구조적으로 고객에게 부당한 불이익을 주는가?"
   (B) 효과:
       - 관할법원을 사업자 소재지로 일방 지정  
       - 입증책임을 고객에게 과도하게 전가  
       - 개인정보를 과도하게 활용·제공  
       - 계약 해석에 있어 **법령·상관례보다 회사 내부 규정·해석을 우선**하도록 하는 구조
   (C) 우선 선택:
       - 1~7번 중 어느 하나로 **명확히** 분류 가능하면 8번을 쓰지 않는다.
       - 관할법원·분쟁절차·입증책임·내부 규정 우선 등,
         책임/권리/비용이 섞여 있으나 어느 하나를 “주제”로 보기 애매한 경우에 한해 8번 허용
   (D) 금지/주의:
       - 데이터 균형·편의 때문에 8번을 선택하면 안 됨.
       - 8번은 **정말로 다른 유형으로 깔끔하게 들어가지 않을 때만** 사용하는 “마지막 선택지”.

--------------------------------
[3번 vs 6번 vs 7번 – 자주 헷갈리는 경우 요약]
--------------------------------

1) 먼저 조항의 “핵심 질문”을 정합니다.
- “이의를 제기할 수 없다, 포인트를 사용할 수 없다” 등
  → 권리 행사 자체가 주제 → 3번 후보
- “제세공과금, 수수료, 환급 불가, 위약금” 등
  → 금전 부담·환급 조건이 주제 → 6번 후보
- “책임을 지지 않는다, 손해는 고객 부담” 등
  → 손해·책임 분담이 주제 → 7번 후보

2) 다음과 같은 경우에는 **3번 사용 금지**:
- 조항의 핵심 단어가
  "책임", "손해", "손해배상", "배상", "보상", "면책", "위험 부담", "담보",
  "소송", "재판", "관할법원", "분쟁", "입증책임" 중 하나인 경우
- 권리 제한의 결과가 실질적으로 **카드사의 손해배상·책임 부담을 줄이거나 회피**시키는 구조인 경우

→ 위에 해당하면 7번(또는 필요시 8번)을 사용하고, 3번은 선택하지 않습니다.

--------------------------------
[최종 선택 절차]
--------------------------------

1. [본 조항]만 읽고, 이 조항의 **핵심 주제**가 무엇인지 한 문장으로 머릿속에 정리합니다.
2. 그 주제가 1~7번 중 어디에 가장 잘 들어맞는지 확인합니다.
3. 둘 이상 가능한 경우, 위에서 제시한 **우선 선택 규칙**에 따라 하나를 고릅니다.
   - “기한의 이익 상실/즉시 상환”이 있으면 → 2번 우선
   - 책임·손해·면책이 핵심이면 → 7번을 3번보다 우선
   - 해지 사유 포괄 vs 통지 방식 문제이면 → 5번을 4번보다 우선
4. 끝까지 애매하여 1~7번으로 깔끔하게 들어가지 않는 경우에만 8번을 사용합니다.

--------------------------------
[최종 출력 형식]
--------------------------------

아래 [선택 예시]의 8개 유형 중에서 **가장 적절한 유형 이름 전체 한 줄만** 그대로 선택하세요.

[선택 예시]
불공정 (1. 서비스 일방적 변경·중단)
2. 기한의 이익 상실
3. 고객 권리 제한
4. 통지·고지 부적절
5. 계약 해지·변경 사유 포괄적
6. 비용 과다 부과·환급 제한
7. 면책·책임 전가
8. 기타 불공정 약관

선택한 가장 적절한 유형을 아래 [출력 예시]에 맞춰서 출력하세요. 설명, 이유, 번호만 단독 출력 등은 절대 추가하지 마십시오.

[출력 예시]
불공정 (선택한 유형)
"""



def GENERATE_PROPOSAL_PROMPT(
    original_clause: str,
    unfair_type: str = "",
    related_cases: str = "",
    related_laws: str = "",
    feedback_context: str = ""
) -> str:
    
    prompt = "당신은 법률 전문가입니다.\n\n"
    
    if original_clause:
      prompt += f"[원본 약관 조항]\n{original_clause}\n\n"
    
    if unfair_type:
      prompt += f"[불공정 유형]\n{unfair_type}\n\n"
        
    if related_cases:
      prompt += f"[관련 시정 사례 및 법령]\n{related_cases}\n\n"
      
    if feedback_context:
        prompt += (
            f"""--- [수정 요청 처리] ---
            사용자가 아래 [피드백]을 통해 수정을 요청했습니다. [판단 및 행동 지침]을 참고한 상태로 [피드백]을 반영하세요.

            [판단 및 행동 지침]
            1. **적법성 최우선**: 사용자의 요청이 [참고 자료](법령, 판례)에 위배되거나 '불공정 약관'이 될 소지가 있는지 검토하십시오.
               (예: 고객의 해지권 제한, 과도한 위약금, 회사의 일방적 면책 등)
            2. **위험 시 거절 및 대안**: 요청이 법적으로 위험하다면 **그대로 반영하지 마십시오.**
               - 대신 '법적 허용 범위 내'에서 사용자의 의도를 살린 대안을 작성하십시오.
               - 그리고 [핵심 변경 사항] 표에 '법적 위험으로 인한 수정/거절 사유'를 명시하십시오.
            3. **정상 처리**: 법적 문제가 없다면 사용자의 의도를 충실히 반영하여 약관을 수정하십시오.
            --------------------------------------------
            
            [피드백]
            {feedback_context}
            
            """
        )
    
    prompt += (
      "[작업]\n"
      "1. [원본 약관 조항]을(를) [참고 자료]를 바탕으로 개선하세요.\n"
      "2. 원본에서 '삭제/수정'되어야 할 부분은 '~~삭제할 내용~~' (취소선)으로 표시하세요.\n"
      "3. 원본에 '추가'되어야 할 부분은 '**추가할 내용**' (굵게)으로 표시하세요.\n"
      "4. 원본에서 변경이 없는 부분은 그대로 두세요. (이 4가지 규칙을 조합하여 인라인 diff를 만드세요. '인라인 diff'라는 말을 직접 언급하지 마세요.)\n"
      "5. 이 개선의 '핵심 변경 사항'을(를) Markdown 표로 요약하세요.\n\n"
      "**[중요!!]** 반드시 다음 마크다운 형식만 따르세요.\n"
      "'판단 근거', '추가 설명', '개선 사유' 등 지정되지 않은 항목을 절대 추가하지 마세요.\n\n"
      "[출력 형식]\n"
      "### 3. 개선된 약관 조항\n"
      "(여기에 2, 3, 4번 규칙을 적용한 '인라인 diff' 텍스트를 작성)\n\n"
      "### 4. 핵심 변경 사항\n"
      "| 변경 전 | 변경 후 |\n"
      "| --- | --- |\n"
      "| (변경 전 핵심 내용) | (변경 후 핵심 내용) |"
    )
    
    return prompt





GEVAL_PROMPT = """당신은 금융 분야 약관 심사 전문가입니다.

[평가 대상]
원본: {original_clause}
유형: {unfair_type}
법령: {predicted_laws}
사례: {similar_cases}
개선안: {improvement_proposal}

[정답]
법령: {expected_laws}
사례: {reference_case}

[평가 항목 - 각 10점]

1. 법령 선택 적절성
2. 사례 활용도
3. 개선안 구체성

[출력]
법령 적절성: [점수]/10
사례 활용도: [점수]/10
개선안 구체성: [점수]/10
총점: [점수]/30

평가 근거: [각 항목별 2-3문장]"""



IMPROVEMENT_EVAL_PROMPT = """당신은 약관 심사 실무 담당자입니다.

[평가 대상]
원본 약관: {original_clause}
개선안: {improvement_proposal}
적용 법령: {laws}
개선 사유: {reason}

[평가 항목]
다음 2가지 항목을 평가하세요.

1. 개선안 실효성 (10점 만점)
- 평가 기준: 이 개선안이 불공정성을 실제로 해소하는가?
- 10점: 불공정성 완전 해소, 법령 요건 완벽 충족
- 7-9점: 불공정성 대부분 해소, 일부 보완 필요
- 4-6점: 부분적 해소, 핵심 문제 일부 미해결
- 1-3점: 형식적 수정, 실질적 개선 미흡
- 0점: 불공정성 해소 안 됨

2. 실무 채택 가능성 (YES/NO)
- 평가 기준: 수정 없이 바로 사용 가능한가?
- YES 조건 (모두 충족):
  * 법령 근거가 명확히 제시됨
  * 구체적인 기한/절차/방법이 명시됨
  * 문구가 명확하고 모호하지 않음
  * 실무에서 즉시 적용 가능
- NO 조건 (하나라도 해당):
  * 법령 근거 불명확
  * 추상적이거나 모호한 표현
  * 실무 적용을 위해 추가 수정 필요

[출력 형식]
반드시 아래 JSON 형식으로만 답변하세요.
{{
  "effectiveness": {{
    "score": 0-10 사이 정수,
    "reason": "100자 이내 평가 근거"
  }},
  "adoptability": {{
    "decision": "YES" 또는 "NO",
    "reason": "100자 이내 판단 근거"
  }}
}}
"""

# 현재 사용 프롬프트
ACTIVE_FAIRNESS_CLASSIFY_PROMPT = FAIRNESS_CLASSIFY_PROMPT
ACTIVE_UNFAIR_TYPE_PROMPT = UNFAIR_TYPE_PROMPT
ACTIVE_GENERATE_PROPOSAL_PROMPT = GENERATE_PROPOSAL_PROMPT
ACTIVE_GEVAL_PROMPT = GEVAL_PROMPT
ACTIVE_IMPROVEMENT_EVAL_PROMPT = IMPROVEMENT_EVAL_PROMPT